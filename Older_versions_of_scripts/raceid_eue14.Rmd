---
title: "RaceID analysis on Electoporated cells (E14)"
author: "Bismark Appiah"
date: "11 April 2020"
output: 
  word_document: 
    fig_height: 10
    fig_width: 15
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages, message=FALSE, warning=FALSE}
library(RaceID)
library(BiocStyle)
library(readr)
library(data.table)
library(dplyr)
library(tools)
library(SingleCellExperiment)
library(HDF5Array)
library(mvoutlier)
library(scran)
library(scater)
library(SC3)
library(slingshot)
library(stringr)
library(org.Mm.eg.db)
library(mclust)
library(RColorBrewer)
library(umap)
library(latexpdf)
```


# 1. Data preparation  
#Loading data matrix

Convert data to "SingleCellExperiment" Class.
## Define DMSO and EPZ conditions  
```{r dataprocessing, message=FALSE, include=FALSE}
data3 <- readRDS("EUE14ALL.RData")
sc_EUE14 <- SCseq(data3)
rm(data3)
gm <- rownames(sc_EUE14@ndata)[grep("Gm\\d+","Kcnq1","Hba-a1|Hba","Gapdh","RP23-341H2.4","A430073D23Rik", rownames(sc_EUE14@ndata))]
sc_EUE14 <- filterdata(sc_EUE14,mintotal=2500,minexpr = 10,minnumber = 5,CGenes = gm, ccor = 0.4)
fdata <- getfdata(sc_EUE14)
sc_EUE14 <- compdist(sc_EUE14,metric="spearman")
sc_EUE14 <- clustexp(sc_EUE14,rseed = 17000)
```

```{r include=FALSE}
plotsaturation(sc_EUE14,disp=FALSE)
plotsaturation(sc_EUE14,disp=TRUE)
```

```{r satplots, include=FALSE}
plotjaccard(sc_EUE14)
```

```{r clustexp, include=FALSE}
sc_EUE14 <- clustexp(sc_EUE14,cln=4,sat=FALSE)
```

```{r outliers, echo=TRUE}
sc_EUE14 <- findoutliers(sc_EUE14,outlg = 10)
```

```{r background, include=FALSE}
plotbackground(sc_EUE14)
```


```{r sensitivity, include=FALSE}
plotsensitivity(sc_EUE14)
```

```{r outlierprobs, echo=TRUE}
plotoutlierprobs(sc_EUE14)
```


```{r computetsne, echo=TRUE}
set.seed(200)
sc_EUE14 <- comptsne(sc_EUE14)
```


```{r echo=TRUE}
plotmap(sc_EUE14,cex = 2)
```


# Extracting marker genes for each cluster

# marker genes for cluster 1
```{r echo=TRUE}
c1_marker <- clustdiffgenes(sc_EUE14,1,pvalue=.01)
c1_marker[1:10,]
```


# marker genes for cluster 2
```{r echo=TRUE}
c2_marker <- clustdiffgenes(sc_EUE14,2,pvalue=.01)
c2_marker[1:20,]
```

# marker genes for cluster 3
```{r echo=TRUE}
c3_marker <- clustdiffgenes(sc_EUE14,3,pvalue=.01)
c3_marker[1:10,]
```

# marker genes for cluster 4
```{r echo=TRUE}
c4_marker <- clustdiffgenes(sc_EUE14,4,pvalue=.01)
c4_marker[1:10,]
```

# marker genes for cluster 5
```{r echo=TRUE}
c5_marker <- clustdiffgenes(sc_EUE14,5,pvalue=.01)
c5_marker[1:20,]
```

# Extracting matrix with cellnames for Ctrl and EPZ conditions
```{r echo=TRUE}
EUE14DM<- sc_EUE14@ndata[, grep('^EUEE14DMSO', colnames(sc_EUE14@ndata))]
EUE14DM <- colnames(EUE14DM)
EUE14EP<- sc_EUE14@ndata[, grep('^EUEE14EPZ', colnames(sc_EUE14@ndata))]
EUE14EP <- colnames(EUE14EP)
```

# DEG analysis - Ctrl vs EPZ
```{r echo=TRUE}
E14_EUE <- diffexpnb(getfdata(sc_EUE14,n=c(EUE14DM,EUE14EP)), A=EUE14DM, B=EUE14EP)
DEGs_E14_EUE_all <- E14_EUE$res[order(E14_EUE$res$log2FoldChange),]
DEGs_E14_EUE_all[1:20,]

```

# t-SNE map of selected markers
```{r echo=TRUE, paged.print=FALSE}
plotexpmap(sc_EUE14,"Zic4",logsc = T,cex = 2)
plotexpmap(sc_EUE14,"Wnt8b",logsc = T,cex = 2)
plotexpmap(sc_EUE14,"Dennd5b",logsc = T,cex = 2)
plotexpmap(sc_EUE14,"Zic1",logsc = T,cex = 2)
```


# Computing contribution of each condition to proportion of cells in each cluster
```{r echo=TRUE}
clust <- sc_EUE14@cpart
clust_pts <- data.frame(names=names(clust),cluster=clust)
clust_pts$condition <- substr(clust_pts$names, start = 0, stop = 9)
table_clust_pts <- table(clust_pts$condition, clust_pts$cluster)
table_clust_pts_1 <- table_clust_pts[1:2,]
table_clust_pts_1
```


```{r echo=TRUE, fig.height=10, fig.width=10}
#A <- names(sc@cpart)[sc@cpart %in% c(2,4)]
#B <- names(sc@cpart)[sc@cpart %in% c(3)]
x <- diffexpnb(getfdata(sc_EUE14,n=c(EUE14DM,EUE14EP)), A=EUE14DM, B=EUE14EP)

plotdiffgenesnb(x,pthr=.05,lthr=.5,mthr=-1,Aname="DMSO",Bname="EPZ",show_names=TRUE,padj=TRUE)
```


```{r echo=TRUE}
#write.csv2(DEGs_E14_EUE_all,file = "DEGs_E14_EUE_all.csv")
library(ggplot2)
library(ggrepel)
data <- read.csv2("DEGs_E14_EUE_all.csv", header = TRUE, sep = "", quote = "\"",
          dec = ",", fill = TRUE)
rownames(data) <- data[,1]
data <- data[,-1]
data$threshold = as.factor(data$padj < 0.2)
res_tableOE_ordered <- data[order(data$padj), ] 

res_tableOE_ordered$genelabels <- ""
res_tableOE_ordered$genelabels[1:40] <- rownames(res_tableOE_ordered)[1:40]

#View(res_tableOE_ordered)

ggplot(res_tableOE_ordered) +
  geom_point(aes(x = log2FoldChange, y = -log10(padj), colour = threshold)) +
  geom_text_repel(aes(x = log2FoldChange, y = -log10(padj), label = ifelse(threshold == T, res_tableOE_ordered$genelabels,""))) +
  ggtitle("Top 25 Differentially Expressed genes") +
  xlab("log2 fold change") + 
  ylab("-log10 adjusted p-value") +
  theme(legend.position = "none",
        plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = rel(1.25))) 

```

# DEG analysis between DMSO and EPZ for each cluster
## DEG between DMSO and EPZ for cluster 1
```{r echo=TRUE}
library(RaceID)
degs_1 <- names(sc_EUE14@cpart)[sc_EUE14@cpart%in% c(1)]
degs_1_dmso <- degs_1[degs_1%in%EUE14DM]
degs_1_epz <- degs_1[degs_1%in%EUE14EP]
y <- diffexpnb(getfdata(sc_EUE14,n=c(degs_1_dmso,degs_1_epz)), A=degs_1_dmso, B=degs_1_epz )
E14_EUE_C1 <- y$res[order(y$res$log2FoldChange),]

```

```{r echo=TRUE}
library(ggplot2)
library(ggrepel)
data <- read.csv2("E14_EUE_C1.csv", header = TRUE, sep = "", quote = "\"",
          dec = ",", fill = TRUE)
rownames(data) <- data[,1]
data <- data[,-1]
data$threshold = as.factor(data$padj < 0.2)
res_tableOE_ordered <- data[order(data$padj), ] 

res_tableOE_ordered$genelabels <- ""
res_tableOE_ordered$genelabels[1:40] <- rownames(res_tableOE_ordered)[1:40]

#View(res_tableOE_ordered)

ggplot(res_tableOE_ordered) +
  geom_point(aes(x = log2FoldChange, y = -log10(padj), colour = threshold)) +
  geom_text_repel(aes(x = log2FoldChange, y = -log10(padj), label = ifelse(threshold == T, res_tableOE_ordered$genelabels,""))) +
  ggtitle("Top 25 Differentially Expressed genes (Cluster 1)") +
  xlab("log2 fold change") + 
  ylab("-log10 adjusted p-value") +
  theme(legend.position = "none",
        plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = rel(1.25))) 

```

## DEG between DMSO and EPZ for cluster 2
```{r echo=TRUE}
library(RaceID)
degs_1 <- names(sc_EUE14@cpart)[sc_EUE14@cpart%in% c(2)]
degs_1_dmso <- degs_1[degs_1%in%EUE14DM]
degs_1_epz <- degs_1[degs_1%in%EUE14EP]
y <- diffexpnb(getfdata(sc_EUE14,n=c(degs_1_dmso,degs_1_epz)), A=degs_1_dmso, B=degs_1_epz )
E14_EUE_C2 <- y$res[order(y$res$log2FoldChange),]


```

```{r echo=TRUE}
library(ggplot2)
library(ggrepel)
data <- read.csv2("E14_EUE_C2.csv", header = TRUE, sep = "", quote = "\"",
          dec = ",", fill = TRUE)
rownames(data) <- data[,1]
data <- data[,-1]
data$threshold = as.factor(data$padj < 0.2)
res_tableOE_ordered <- data[order(data$padj), ] 

res_tableOE_ordered$genelabels <- ""
res_tableOE_ordered$genelabels[1:40] <- rownames(res_tableOE_ordered)[1:40]

#View(res_tableOE_ordered)

ggplot(res_tableOE_ordered) +
  geom_point(aes(x = log2FoldChange, y = -log10(padj), colour = threshold)) +
  geom_text_repel(aes(x = log2FoldChange, y = -log10(padj), label = ifelse(threshold == T, res_tableOE_ordered$genelabels,""))) +
  ggtitle("Top 25 Differentially Expressed genes (Cluster 2)") +
  xlab("log2 fold change") + 
  ylab("-log10 adjusted p-value") +
  theme(legend.position = "none",
        plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = rel(1.25))) 

```


## DEG between DMSO and EPZ for cluster 3
```{r echo=TRUE}
library(RaceID)
degs_1 <- names(sc_EUE14@cpart)[sc_EUE14@cpart%in% c(3)]
degs_1_dmso <- degs_1[degs_1%in%EUE14DM]
degs_1_epz <- degs_1[degs_1%in%EUE14EP]
y <- diffexpnb(getfdata(sc_EUE14,n=c(degs_1_dmso,degs_1_epz)), A=degs_1_dmso, B=degs_1_epz )
E14_EUE_C3 <- y$res[order(y$res$log2FoldChange),]


```

```{r echo=TRUE}
library(ggplot2)
library(ggrepel)
data <- read.csv2("E14_EUE_C3.csv", header = TRUE, sep = "", quote = "\"",
          dec = ",", fill = TRUE)
rownames(data) <- data[,1]
data <- data[,-1]
data$threshold = as.factor(data$padj < 0.2)
res_tableOE_ordered <- data[order(data$padj), ] 

res_tableOE_ordered$genelabels <- ""
res_tableOE_ordered$genelabels[1:40] <- rownames(res_tableOE_ordered)[1:40]

#View(res_tableOE_ordered)

ggplot(res_tableOE_ordered) +
  geom_point(aes(x = log2FoldChange, y = -log10(padj), colour = threshold)) +
  geom_text_repel(aes(x = log2FoldChange, y = -log10(padj), label = ifelse(threshold == T, res_tableOE_ordered$genelabels,""))) +
  ggtitle("Top 25 Differentially Expressed genes (Cluster 3)") +
  xlab("log2 fold change") + 
  ylab("-log10 adjusted p-value") +
  theme(legend.position = "none",
        plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = rel(1.25))) 

```


## DEG between DMSO and EPZ for cluster 4
```{r echo=TRUE}
library(RaceID)
degs_1 <- names(sc_EUE14@cpart)[sc_EUE14@cpart%in% c(4)]
degs_1_dmso <- degs_1[degs_1%in%EUE14DM]
degs_1_epz <- degs_1[degs_1%in%EUE14EP]
y <- diffexpnb(getfdata(sc_EUE14,n=c(degs_1_dmso,degs_1_epz)), A=degs_1_dmso, B=degs_1_epz )
E14_EUE_C4 <- y$res[order(y$res$log2FoldChange),]


```

```{r echo=TRUE}
library(ggplot2)
library(ggrepel)
data <- read.csv2("E14_EUE_C4.csv", header = TRUE, sep = "", quote = "\"",
          dec = ",", fill = TRUE)
rownames(data) <- data[,1]
data <- data[,-1]
data$threshold = as.factor(data$padj < 0.2)
res_tableOE_ordered <- data[order(data$padj), ] 

res_tableOE_ordered$genelabels <- ""
res_tableOE_ordered$genelabels[1:40] <- rownames(res_tableOE_ordered)[1:40]

#View(res_tableOE_ordered)

ggplot(res_tableOE_ordered) +
  geom_point(aes(x = log2FoldChange, y = -log10(padj), colour = threshold)) +
  geom_text_repel(aes(x = log2FoldChange, y = -log10(padj), label = ifelse(threshold == T, res_tableOE_ordered$genelabels,""))) +
  ggtitle("Top 25 Differentially Expressed genes (Cluster 4)") +
  xlab("log2 fold change") + 
  ylab("-log10 adjusted p-value") +
  theme(legend.position = "none",
        plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = rel(1.25))) 

```


## DEG between DMSO and EPZ for cluster 5
```{r echo=TRUE}
library(RaceID)
degs_1 <- names(sc_EUE14@cpart)[sc_EUE14@cpart%in% c(5)]
degs_1_dmso <- degs_1[degs_1%in%EUE14DM]
degs_1_epz <- degs_1[degs_1%in%EUE14EP]
y <- diffexpnb(getfdata(sc_EUE14,n=c(degs_1_dmso,degs_1_epz)), A=degs_1_dmso, B=degs_1_epz )
E14_EUE_C5 <- y$res[order(y$res$log2FoldChange),]

```

```{r echo=TRUE}
library(ggplot2)
library(ggrepel)
data <- read.csv2("E14_EUE_C5.csv", header = TRUE, sep = "", quote = "\"",
          dec = ",", fill = TRUE)
rownames(data) <- data[,1]
data <- data[,-1]
data$threshold = as.factor(data$padj < 0.2)
res_tableOE_ordered <- data[order(data$padj), ] 

res_tableOE_ordered$genelabels <- ""
res_tableOE_ordered$genelabels[1:40] <- rownames(res_tableOE_ordered)[1:40]

#View(res_tableOE_ordered)

ggplot(res_tableOE_ordered) +
  geom_point(aes(x = log2FoldChange, y = -log10(padj), colour = threshold)) +
  geom_text_repel(aes(x = log2FoldChange, y = -log10(padj), label = ifelse(threshold == T, res_tableOE_ordered$genelabels,""))) +
  ggtitle("Top 25 Differentially Expressed genes (Cluster 5)") +
  xlab("log2 fold change") + 
  ylab("-log10 adjusted p-value") +
  theme(legend.position = "none",
        plot.title = element_text(size = rel(1.5), hjust = 0.5),
        axis.title = element_text(size = rel(1.25))) 

```


















